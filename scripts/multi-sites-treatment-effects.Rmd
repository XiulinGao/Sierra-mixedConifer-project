---
title: "multi-sites-treatment-effects"
author: "Xiulin Gao"
date: "2025-04-20"
output: html_document
---

```{r setup, include=FALSE}
home_path   = path.expand("~")
main_path   = file.path("/Volumes/Ldian/FATES/exp-3sites")
util_path   = file.path(home_path,"Util/RUtils")
hlm_files   = c("blodgett-exp-0420_hlm1d.csv",
                "Teakettle-exp_hlm1d.csv",
                "STEF-exp-10yr_hlm1d.csv")
hlm_paths   = file.path(main_path,hlm_files)
pft_files  = c("blodgett-exp-0420_bypft-dbh10.csv",
               "Teakettle-exp_bypft-dbh10.csv",
               "STEF-exp-10yr_bypft-dbh10.csv")
pft_paths   = file.path(main_path,pft_files)
dbh_files  = c("blodgett-exp-0420_bydbh.csv",
               "Teakettle-exp_bydbh.csv",
               "STEF-exp-10yr_bydbh.csv")
dbh_paths   = file.path(main_path,dbh_files)
fuel_files = c("blodgett-exp-0420_byfuel.csv",
               "Teakettle-exp_byfuel.csv",
               "STEF-exp-10yr_byfuel.csv")
fuel_paths   = file.path(main_path,fuel_files)
nsites = length(fuel_paths)

case_desc = c("Blodgett-Control",
              "Blodgett-75-50-20-BA40",
              "Blodgett-Rx-InclusiveBW",
              "Blodgett-Rx-SelectiveBW",
              "Teakettle-Control",
              "Teakettle-45-90-100-BA40",
              "Teakettle-Rx-InclusiveBW",
              "Teakettle-Rx-SelectiveBW",
              "STEF-Control",
              "STEF-75-50-20-BA49p5",
              "STEF-Rx-InclusiveBW",
              "STEF-Rx-SelectiveBW")
names(case_desc) = c("1","2","3","4","5","6","7","8","9","10","11","12")
ncase = length(case_desc)/nsites

```




```{r MakeDir}

#plot path
plot_main  = file.path(main_path,"Figures")
# Output path for time series
pft_path     = file.path(plot_main,"Effects-PFT"     )
size_path    = file.path(plot_main,"Effects-DBH"     )
mean_path    = file.path(plot_main,"Effects-Mean"    )

# Create paths for time series
dummy = dir.create(pft_path    , recursive = TRUE, showWarnings = FALSE)
dummy = dir.create(size_path   , recursive = TRUE, showWarnings = FALSE)
dummy = dir.create(mean_path   , recursive = TRUE, showWarnings = FALSE)

```



```{r Packages}
library(ggplot2)
library(tidyverse)
library(lubridate)


```



```{r UserPFTFuelInfo}
## PFT info
user_pftinfo  = TRUE

# List of PFTs, in case user_pftinfo is TRUE
n            = 0
pftinfo      = list()
n            = n + 1
pftinfo[[n]] = list( id     = 1
                     , key    = "pft1"
                     , short  = "Pine"
                     , desc   = "Pine tree"
                     , colour = "#74A089"
                     , parse  ="P*i*n*e[E*v*g*r*n]"
)
n            = n + 1
pftinfo[[n]] = list( id     = 2
                     , key    = "pft2"
                     , short  = "Cedar"
                     , desc   = "Incense cedar"
                     , colour = "#9A8822"
                     , parse  ="C*e*d*a*r[E*v*g*r*n]"
)       
n            = n + 1
pftinfo[[n]] = list( id     = 3
                     , key    = "pft3"
                     , short  = "Fir"
                     , desc   = "White fir"
                     , colour = "#F8AFA8"
                     , parse  ="F*i*r[E*v*g*r*n]"
) 
n            = n + 1
pftinfo[[n]] = list( id     = 4
                     , key    = "pft4"
                     , short  = "Oak"
                     , desc   = "Black oak"
                     , colour = "#FDDDA0"
                     , parse  ="F*i*r[E*v*g*r*n]"
) #end of PFT list

pftinfo  = do.call(what=rbind,args=lapply(X=pftinfo,FUN=as_tibble,stringsAsFactors=FALSE))
npfts = nrow(pftinfo)


# List of fuels, in case user_fuleinfo is TRUE
n               = 0
fuelinfo        = list()
n               = n + 1
fuelinfo[[n]]   = list( id      = 1
                      , key     = "fuel1"
                      , short   = "Twig"
                      , desc    = "Fuel from twig" 
                      , colour  = "#E69F00"
                      , parse   = "F*u*e*l[T*w*i*g]")
n               = n + 1
fuelinfo[[n]]   = list( id      = 2
                      , key     = "fuel2"
                      , short   = "SBranch"
                      , desc    = "Fuel from small branch" 
                      , colour  = "#56B4E9"
                      , parse   = "F*u*e*l[S*b*r*a*n*c*h]")
n               = n + 1
fuelinfo[[n]]   = list( id      = 3
                      , key     = "fuel3"
                      , short   = "LBranch"
                      , desc    = "Fuel from large branch" 
                      , colour  = "#0072B2"
                      , parse   = "F*u*e*l[L*b*r*a*n*c*h]")
n               = n + 1
fuelinfo[[n]]   = list( id      = 4
                      , key     = "fuel4"
                      , short   = "Trunk"
                      , desc    = "Fuel from trunk" 
                      , colour  = "#D55E00"
                      , parse   = "F*u*e*l[T*r*u*n*k]")
n               = n + 1
fuelinfo[[n]]   = list( id      = 5
                      , key     = "fuel5"
                      , short   = "DeadLeaf"
                      , desc    = "Fuel from dead leaf" 
                      , colour  = "#999999"
                      , parse   = "F*u*e*l[D*l*e*a*f]")
n               = n + 1
fuelinfo[[n]]   = list( id      = 6
                      , key     = "fuel6"
                      , short   = "LiveGrass"
                      , desc    = "Fuel from live grass" 
                      , colour  = "#009E73"
                      , parse   = "F*u*e*l[L*g*r*a*s*s]") #end of fuel list

fuelinfo  = do.call(what=rbind,args=lapply(X=fuelinfo,FUN=as_tibble,stringsAsFactors=FALSE))
nfuels = nrow(fuelinfo)

```




```{r DBHInfo}

ndbhs = 13
dbh_lwr = c(0,5,10,15,20,30,40,50,60,70,80,90,100)
dbh_upr = c(dbh_lwr[-1],dbh_lwr[ndbhs]+2*max(diff(dbh_lwr)))
dbh_labs = c( paste0("paste(",dbh_lwr[-ndbhs],"-",dbh_upr[-ndbhs],")")
                        , paste0("paste(",dbh_lwr[ ndbhs],"-infinity)"))
dbh_desc = c( paste0("paste(paste(",dbh_lwr[-ndbhs],"<=D*B*H)<",dbh_upr[-ndbhs],"*c*m)")
                          , paste0("paste( D*B*H >=",dbh_lwr[ndbhs],"*c*m)"))

dbh_labs_10     = c(dbh_labs[5:13], "paste(10-20)")
dbh_labs_10    = parse(text=dbh_labs_10)
names(dbh_labs_10) = c("5","6","7","8","9","10","11","12","13","4")

dbh_labs = parse(text=dbh_labs)
dbh_labs_10 = parse(text=dbh_labs_10)


```





```{r PlotSettings}

gg_device  = c("png")     # Output devices to use (Check ggsave for acceptable formats)
gg_depth   = 600          # Plot resolution (dpi)
gg_ptsz    = 18           # Font size
gg_ptszl   = 26
gg_width   = 17.5         # Plot width (units below)
gg_widthn  = 14.5
gg_height  = 8.5          # Plot height (units below)
gg_units   = "in"         # Units for plot size
gg_screen  = FALSE         # Show plots on screen as well?
gg_tfmt    = "%Y"         # Format for time strings in the time series %Y: 4 DIGITS YEAR %y 2 digits year
gg_ncolours    = 129      # Number of node colours for heat maps.
gg_fleg        = 1./6.    # Fraction of plotting area dedicated for legend
gg_dstat_thick = 0.1      # Thickess for the drought-deciduous status band in the stress overview plot (Value


ens_colour = c("#A0AE6A", "#836B43", "#D68D18", "#437683", "#18B0D6")

top12 <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
           "#44AA99", "#999933", "#882255", "#6699CC", "#888888", "#661100")

site_colour  = "#000000"

ndevice = length(gg_device)


# Define lower and upper bound for interannual variability ribbon around the mean.
sdev_ribbon  = 1.                  # Standard-deviation equivalent for ribbon 
qlwr_ribbon  = pnorm(-sdev_ribbon) # Lower quantile for ribbon
qupr_ribbon  = pnorm(+sdev_ribbon) # Lower quantile for ribbon
alpha_ribbon = 0.2

```





```{r Constants}
month_2_sec = 2628000
ha_2_m2 = 10000

```




```{r ReadAndAppend}
ReadAppend_fun = function(path,n_site,n_case,case_desc){
  return_df = NULL
  for (s in sequence(n_site)){
   case_up = s * n_case
   case_lw = (s-1)*n_case + 1
   case_now = c(case_lw:case_up)
   df_now = data.table::fread(path[s])
   df_now = df_now          %>% 
            dplyr::mutate(case = case_when(case==1 ~ case_now[1],
                                          case==2 ~ case_now[2],
                                          case==3 ~ case_now[3],
                                          case==4 ~ case_now[4]),
                         desc = case_desc[case])
   
   if(is.null(return_df)){
     return_df = df_now
   }else{
     return_df = rbind(return_df,df_now)
   }
  }
  return(return_df)
  
}
all_paths = c("hlm_paths","pft_paths","dbh_paths","fuel_paths")
file_name = c("hlm1d-3sites.csv","bypft-3sites.csv","bydbh-3sites.csv","byfuel-3sites.csv")
n_path = length(all_paths)
for(p in sequence(n_path)){
  p_now = get(all_paths[p])
  f_now = file_name[p]
  df_now = ReadAppend_fun(p_now,nsites,ncase,case_desc)
  data.table::fwrite(df_now,file=file.path(main_path,f_now))
}





```




```{r SomeFunctions}
rename_fun = function(x){
  x = gsub(pattern="fates_",replacement = "ctrl_",x)
}

delta_pct_fun = function(df,x,quant_up,quant_lw){
  ctrl_name = rename_fun(x)
  df[[x]] = (df[[x]] - df[[ctrl_name]]) / df[[ctrl_name]] * 100
  df[[x]] = ifelse(df[[x]]==Inf, NA, df[[x]])
  up_thresh = quantile(df[[x]],quant_up,na.rm=TRUE)
  lw_thresh = quantile(df[[x]],quant_lw,na.rm=TRUE)
  df[[x]] = ifelse(df[[x]] > up_thresh | df[[x]] < lw_thresh, NA, df[[x]])
}

delta_fun = function(df,x){
  ctrl_name = rename_fun(x)
  df[[x]] = df[[x]] - df[[ctrl_name]]
}

site_grab = function(desc){
  site = sub("-.*","",desc) 
}

treatment_grab = function(desc){
  if(grepl("[0-9]+-BA[0-9]+",desc)){treat = "Logging"}
  else if(grepl("Rx-Inclusive",desc)){treat="Rx-Inclusive"}
  else if(grepl("Rx-Selective",desc)){treat="Rx-Selective"}
  else{treat = "None"}
 # treat = if_else(grepl("[0-9]+-BA",desc),"Logging","Rx-fire")
}

find_mort = function(x,n){
   mort_mon = ifelse( test = n == 0, yes = NA, no = pmin(1.,x/n/12.))
   mort_year = ifelse(is.na(mort_mon),NA, 100. * (1. - (1. - mort_mon)^12))
   return(mort_year)
}#end function find_mort

```





```{r ByPFTDataProcessing}

bypft = data.table::fread(file.path(main_path,file_name[2]))
bypft = bypft                    %>% 
        select(-c(fates_mortality_cambialburn,
                 fates_mortality_crownscorch,
                 fates_mortality_rxcambial,
                 fates_mortality_rxcrown))
mortout_pft    = names(bypft)[grep(pattern="mortality",x=names(bypft))]
bypft  =     bypft                                              %>% 
             mutate(month = month(time)
                   ,year  = year(time))                         %>% 
             mutate_at(c(mortout_pft),
                       ~ find_mort(x=.x,
                                   n= ifelse(.x=="fates_mortality_ustory", 
                                                   .data$fates_nplant_ustory, 
                                                   .data$fates_nplant)))
bypft$fates_mortality = bypft %>% select(starts_with("fates_mortality")) %>% rowSums()

bypft = bypft                                                                            %>% 
mutate(fates_ddbh_canopy = ifelse(is.na(fates_nplant_canopy) | fates_nplant_canopy==0,
                           NA, fates_ddbh_canopy*ha_2_m2/fates_nplant_canopy),
       fates_ddbh_ustory = ifelse(is.na(fates_nplant_ustory) | fates_nplant_ustory==0,
                           NA, fates_ddbh_ustory*ha_2_m2/fates_nplant_ustory),
      fates_ddbh         = ifelse(is.na(fates_nplant) | fates_nplant==0, 
                           NA, fates_ddbh*ha_2_m2/fates_nplant))

ctrl = bypft %>% filter(case %in% c(1,5,9))
ctrl = ctrl                    %>% 
       group_by(case,desc)     %>% 
       slice(rep(seq_len(n()),times = nsites)) %>% ungroup()


delta_vars = c("fates_nplant",
               "fates_nplant_ustory",
               "fates_ddbh",
               "fates_basalarea",
               "fates_mortality")
delta_desc = c("stem density",
               "understory stem density",
               "growth rate",
               "basal area",
               "mortality")

n_delta = length(delta_vars)


ctrl_bypft =  ctrl                       %>% 
              select(all_of(delta_vars)) %>% 
              rename_at(vars(fates_nplant:fates_mortality),rename_fun)

treat_bypft = bypft                                   %>% 
              filter(!case%in% c(1,5,9))             

treat_bypft = treat_bypft %>% select(all_of(c("case",
                                              "time",
                                              "pft",
                                              "desc",
                                              delta_vars)))
    

delta_bypft = cbind(treat_bypft,ctrl_bypft)
#delta_bypft = delta_bypft                    %>% 
#              mutate(year=year(time))        %>% 
#              select(-time)                  %>% 
#              group_by(case,desc,year,pft)   %>% 
#              summarize_all(mean,na.rm=TRUE) %>% 
#              ungroup()
delta_bypft = delta_bypft                    %>% 
              mutate(site=site_grab(desc))
delta_bypft$treatment = unlist(lapply(delta_bypft$desc,treatment_grab))


for(v in sequence(n_delta)){
  var_now = delta_vars[v]
  delta_bypft[[var_now]] = delta_pct_fun(delta_bypft,var_now,0.95,0.05)
}

treated_case = unique(delta_bypft$case)

#rx_date  =  bypft                                 %>% 
#            filter(fates_mortality_rxfire>0)      %>% 
#            select(case,time)                     %>% 
#            distinct()                            %>% 
#            rename(rx_date = time)                %>% 
#            group_by(case)                        %>% 
#            mutate(lag_rxdate = rx_date - lag(rx_date),
#                   lag_rxdate = as.numeric(lag_rxdate)/month_2_sec)

#twofires_last = which(rx_date$lag_rxdate<2)
#rx_date = rx_date[-(twofires_last-1), ]
#ls_date = as.POSIXct("2020-12-01",tz="UTC")
#rx_delta = delta_bypft %>% filter(case %in% unique(rx_date$case))
#rx_cases = unique(rx_delta$case)

deltabypft_mean = NULL
deltabypft_sd   = NULL

for(n in treated_case){
  delta_now = delta_bypft %>% filter(case==n)
 
  #breaks_now = rx_date$rx_date[rx_date$case==n]
  #breaks_now = c(breaks_now,ls_date)
  #n_bk = length(breaks_now)-1
  #labels = sprintf("RX%i",sequence(n_bk))
    mean_pft  = delta_now                                                 %>% 
               #mutate(RXtrt_grp = cut(time,breaks = breaks_now,labels))  %>% 
               #filter(!is.na(RXtrt_grp))                                 %>%
               select(-c(time,case,desc))                                %>% 
               group_by(site,treatment,pft)                              %>% 
               summarize_all(mean,na.rm=TRUE)
    
    deltabypft_mean = rbind(deltabypft_mean,mean_pft)
    
    sd_pft  = delta_now                                                 %>% 
               #mutate(RXtrt_grp = cut(time,breaks = breaks_now,labels))  %>% 
               #filter(!is.na(RXtrt_grp))                                 %>%
               select(-c(time,case,desc))                                %>% 
               group_by(site,treatment,pft)                              %>% 
               summarize_all(sd,na.rm=TRUE)
     deltabypft_sd = rbind(deltabypft_sd,sd_pft)
    
     
}



```



```{r PlotDeltaByPFTAndTreatment, echo=FALSE}


plot_df = deltabypft_mean
plot_df$pft = factor(plot_df$pft,levels=unique(plot_df$pft))
f_colpfts   = pftinfo$colour
f_pftlabs   = pftinfo$short
names(f_pftlabs) = c("1","2","3","4")

for(d in sequence(n_delta)){
  f_vnam = delta_vars[d]
  f_desc = delta_desc[d]
  plot = ggplot(plot_df,aes_string(x = "site",y=f_vnam,
                   ymin=plot_df[[f_vnam]]-deltabypft_sd[[f_vnam]],
                   ymax=plot_df[[f_vnam]]+deltabypft_sd[[f_vnam]],
                   colour="treatment")) +
       facet_wrap(.~pft,labeller=labeller(pft=f_pftlabs))+
       geom_point(size=2) +
       geom_errorbar(width=0)+
       geom_hline(yintercept = 0, color="black",linetype=2)+
       coord_flip() +
       #scale_colour_manual(values=f_colpfts,labels=f_pftlabs) +
       scale_colour_manual(values=ens_colour) +
       ylab(paste0("Relative change in ", f_desc," (%)")) +
       xlab("") +
       theme_grey( base_size = gg_ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5) +
       theme( legend.title =element_blank()
            , legend.position="bottom"
            , legend.box = "vertical"
            , legend.margin = margin()
            , axis.text.x       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            , axis.text.y       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            )#end theme+
  
  
  for (d in sequence(ndevice)){
    f_output = paste0(f_vnam,"_PFTSplit-smoothed.",gg_device[d])
    dummy    = ggsave( filename = f_output
                    , plot     = plot
                    , device   = gg_device[d]
                    , path     = pft_path
                    , width    = gg_widthn*0.5
                    , height   = gg_height*0.5
                    , units    = gg_units
                    , dpi      = gg_depth
                    )
   }
       

  
}

```




```{r OverallEffectDataProcessing}

overall = data.table::fread(file.path(main_path,file_name[2]))
overall = overall                        %>% 
          group_by(case,desc,time)       %>% 
          select(-pft)                   %>% 
          summarize_all(sum,na.rm=TRUE)  %>% 
          ungroup()

overall = overall                                    %>% 
          select(-c(fates_mortality_cambialburn,
                    fates_mortality_crownscorch,
                    fates_mortality_rxcambial,
                    fates_mortality_rxcrown))

overall = overall                                 %>% 
          mutate(month = month(time)
                ,year  = year(time))              %>% 
             mutate_at(c(mortout_pft),
                       ~ find_mort(x=.x,
                                   n= ifelse(.x=="fates_mortality_ustory", 
                                                   .data$fates_nplant_ustory, 
                                                   .data$fates_nplant)))
overall$fates_mortality = overall %>% select(starts_with("fates_mortality")) %>% rowSums()

overall = overall                                                                           %>% 
mutate(fates_ddbh_canopy = ifelse(is.na(fates_nplant_canopy) | fates_nplant_canopy==0,
                           NA, fates_ddbh_canopy*ha_2_m2/fates_nplant_canopy),
       fates_ddbh_ustory = ifelse(is.na(fates_nplant_ustory) | fates_nplant_ustory==0,
                           NA, fates_ddbh_ustory*ha_2_m2/fates_nplant_ustory),
      fates_ddbh         = ifelse(is.na(fates_nplant) | fates_nplant==0, 
                           NA, fates_ddbh*ha_2_m2/fates_nplant))

ctrl_all = overall %>% filter(case %in% c(1,5,9))
ctrl_all = ctrl_all                %>% 
           group_by(case,desc)     %>% 
           slice(rep(seq_len(n()),times = nsites)) %>% ungroup()

ctrl_all =  ctrl_all                       %>% 
            select(all_of(delta_vars))     %>% 
            rename_at(vars(fates_nplant:fates_mortality),rename_fun)

treat_all = overall                                   %>% 
            filter(!case%in% c(1,5,9))             

treat_all = treat_all %>% select(all_of(c("case",
                                          "time",
                                          "desc",
                                        delta_vars)))
    

delta_treat = cbind(treat_all,ctrl_all)
delta_treat = delta_treat                   %>% 
              mutate(site=site_grab(desc))
delta_treat$treatment = unlist(lapply(delta_treat$desc,treatment_grab))


for(v in sequence(n_delta)){
  var_now = delta_vars[v]
  delta_treat[[var_now]] = delta_pct_fun(delta_treat,var_now,0.95,0.05)
}

delta_mean = NULL
delta_sd   = NULL

for(n in treated_case){
  delta_now = delta_treat %>% filter(case==n)
  mean_now  = delta_now                                             %>% 
              select(-c(time,case,desc))                            %>% 
              group_by(site,treatment)                              %>% 
              summarize_all(mean,na.rm=TRUE)
    
    delta_mean = rbind(delta_mean,mean_now)
    
    sd_now  =  delta_now                                             %>% 
               select(-c(time,case,desc))                            %>% 
               group_by(site,treatment)                              %>% 
               summarize_all(sd,na.rm=TRUE)
    delta_sd = rbind(delta_sd,sd_now)
    
     
}







```



```{r PlotDeltaByTreatment, echo=FALSE}


plot_df = delta_mean

for(d in sequence(n_delta)){
  f_vnam = delta_vars[d]
  f_desc = delta_desc[d]
  plot = ggplot(plot_df,aes_string(x = "site",y=f_vnam,
                   ymin=plot_df[[f_vnam]]-delta_sd[[f_vnam]],
                   ymax=plot_df[[f_vnam]]+delta_sd[[f_vnam]],
                   colour="treatment")) +
       geom_point(size=2) +
       geom_errorbar(width=0)+
       geom_hline(yintercept = 0, color="black",linetype=2)+
       coord_flip() +
       scale_colour_manual(values=ens_colour) +
       ylab(paste0("Relative change in ", f_desc," (%)")) +
       xlab("") +
       theme_grey( base_size = gg_ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5) +
       theme( legend.title =element_blank()
            , legend.position="bottom"
            , legend.box = "vertical"
            , legend.margin = margin()
            , axis.text.x       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            , axis.text.y       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            )#end theme+
  
  
  for (d in sequence(ndevice)){
    f_output = paste0(f_vnam,"_byTreatment-outlierRemoved.",gg_device[d])
    dummy    = ggsave( filename = f_output
                    , plot     = plot
                    , device   = gg_device[d]
                    , path     = mean_path
                    , width    = gg_widthn*0.5
                    , height   = gg_height*0.4
                    , units    = gg_units
                    , dpi      = gg_depth
                    )
   }
       

  
}



```





```{r DeltaGrowthByDBHDataProcessing}

bydbh = data.table::fread(file.path(main_path,file_name[3]))

bydbh = bydbh                          %>% 
mutate(fates_ddbh_canopy = ifelse(is.na(fates_nplant_canopy) | fates_nplant_canopy==0,
                                  NA, fates_ddbh_canopy*ha_2_m2/fates_nplant_canopy),
       fates_ddbh_ustory = ifelse(is.na(fates_nplant_ustory) | fates_nplant_ustory==0,
                                  NA, fates_ddbh_ustory*ha_2_m2/fates_nplant_ustory),
       fates_ddbh        = ifelse(is.na(fates_nplant) | fates_nplant==0, 
                                  NA, fates_ddbh*ha_2_m2/fates_nplant))

ctrl_growth = bydbh %>% filter(case %in% c(1,5,9))
ctrl_growth = ctrl_growth                    %>% 
              group_by(case,desc)            %>% 
              slice(rep(seq_len(n()),times = nsites)) %>% ungroup()


growth_vars = c("fates_ddbh",
               "fates_ddbh_canopy",
               "fates_ddbh_ustory")
growth_desc = c(
               "growth rate",
               "growth rate canopy",
               "growth rate understory")

n_delta = length(growth_vars)


ctrl_growth =  ctrl_growth                     %>% 
               select(all_of(growth_vars))     %>% 
               rename_at(vars(fates_ddbh:fates_ddbh_ustory),rename_fun)

treat_growth = bydbh                                  %>% 
               filter(!case%in% c(1,5,9))             

treat_growth = treat_growth %>% select(all_of(c("case",
                                                "time",
                                                "dbh",
                                                "desc",
                                              growth_vars)))
    

delta_growth = cbind(treat_growth,ctrl_growth)
delta_growth = delta_growth                    %>% 
               mutate(year=year(time))         %>% 
               select(-time)                   %>% 
               group_by(case,desc,year,dbh)    %>% 
               summarize_all(mean,na.tm=TRUE)
               
delta_growth = delta_growth                    %>% 
              mutate(site=site_grab(desc))
delta_growth$treatment = unlist(lapply(delta_growth$desc,treatment_grab))


for(v in sequence(n_delta)){
  var_now = growth_vars[v]
  delta_growth[[var_now]] = delta_pct_fun(delta_growth,var_now,0.95,0.05)
}

delta_growth_12 = delta_growth %>% filter(dbh!=1)

deltagrowth_mean = NULL
deltagrowth_sd   = NULL

for(n in treated_case){
  delta_now = delta_growth_12 %>% filter(case==n)
 
  mean_growth  = delta_now                                              %>% 
              select(-c(time,case,desc))                                %>% 
              group_by(site,treatment,dbh)                              %>% 
              summarize_all(mean,na.rm=TRUE)
    
  deltagrowth_mean = rbind(deltagrowth_mean,mean_growth)
    
  sd_growth  = delta_now                                                 %>% 
               select(-c(time,case,desc))                                %>% 
               group_by(site,treatment,dbh)                              %>% 
               summarize_all(sd,na.rm=TRUE)
  deltagrowth_sd = rbind(deltagrowth_sd,sd_growth)
    
     
}




```





```{r PlotDeltaGrowthBySize}

plot_df = delta_growth_12
plot_df$dbh = factor(plot_df$dbh,levels=unique(plot_df$dbh))

for(d in sequence(n_delta)){
  f_vnam = growth_vars[d]
  f_desc = growth_desc[d]
  plot = ggplot(plot_df,aes_string(x = "dbh",y=f_vnam,
                   colour="treatment")) +
       facet_wrap(.~site)+#,scales="free")+
       geom_boxplot(outlier.shape = NA) +
       geom_hline(yintercept = 0, color="black",linetype=2)+
       scale_x_discrete(labels=dbh_labs[2:13]) +
       scale_colour_manual(values=ens_colour) +
       ylab(paste0("Relative change in ", f_desc," (%)")) +
       xlab("") +
       theme_grey( base_size = gg_ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5) +
       theme( legend.title =element_blank()
            , legend.position="bottom"
            , legend.box = "vertical"
            , legend.margin = margin()
            , axis.text.x       = element_text( size   = gg_ptsz
                                              , angle  = 90
                                              , hjust  = 1
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            , axis.text.y       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            )#end theme+
  
  
  for (d in sequence(ndevice)){
    f_output = paste0(f_vnam,"_deltabySZ-smoothed.",gg_device[d])
    dummy    = ggsave( filename = f_output
                    , plot     = plot
                    , device   = gg_device[d]
                    , path     = size_path
                    , width    = gg_widthn*0.8
                    , height   = gg_height*0.7
                    , units    = gg_units
                    , dpi      = gg_depth
                    )
   }
       

  
}


```




```{r DeltaFuelProcessing}

hlm1d = data.table::fread(file.path(main_path,file_name[1]))
fuel  = data.table::fread(file.path(main_path,file_name[4]))

fuel$fuel = factor(fuel$fuel,levels=unique(fuel$fuel))

fuel_notrunk = fuel                            %>% 
               filter(fuel!=4)                 %>% 
               group_by(case,desc,time)        %>% 
               select(-fuel)                   %>% 
               summarize_all(sum,na.rm=TRUE)   %>% 
               ungroup()                       %>% 
               rename(fates_fuel_notrunk = 
                      fates_fuel_amount)
fuel_trunk   = fuel                      %>% 
               filter(fuel==4)           %>% 
               select(-fuel)             %>% 
               rename(fates_fuel_trunk =
                      fates_fuel_amount)

canopy_fuel  =     hlm1d                              %>% 
               select(case,
                      time,
                      desc,
                      fates_canopy_fuel_amount,
                      fates_canopy_fuel_bulkd) 

fuel_df  = fuel_notrunk                          %>% 
           left_join(fuel_trunk,
                     by=c("case","desc","time")) %>% 
           left_join(canopy_fuel,
                     by=c("case","desc","time"))

ctrl_fuel = fuel_df %>% filter(case %in% c(1,5,9))
ctrl_fuel = ctrl_fuel                      %>% 
            group_by(case,desc)            %>% 
            slice(rep(seq_len(n()),times = nsites)) %>% ungroup()


fuel_vars = c("fates_fuel_notrunk",
              "fates_fuel_trunk",
              "fates_canopy_fuel_amount",
              "fates_canopy_fuel_bulkd")
fuel_desc = c("non-trunk fuel load",
              "trunk fuel load",
              "canopy fuel load",
              "canopy bulk density")

n_fuel = length(fuel_vars)


ctrl_fuel =  ctrl_fuel                    %>% 
             select(all_of(fuel_vars))     %>% 
             rename_at(vars(fates_fuel_notrunk:fates_canopy_fuel_bulkd),rename_fun)

treat_fuel = fuel_df                                 %>% 
             filter(!case%in% c(1,5,9))             
  
delta_fuel = cbind(treat_fuel,ctrl_fuel)

delta_fuel = delta_fuel                    %>% 
             mutate(site=site_grab(desc))
delta_fuel$treatment = unlist(lapply(delta_fuel$desc,treatment_grab))


for(v in sequence(n_fuel)){
  var_now = fuel_vars[v]
  delta_fuel[[var_now]] = delta_pct_fun(delta_fuel,var_now,1,0)
}
deltafuel_mean   = NULL
deltafuel_sd     = NULL

for(n in treated_case){
  delta_now = delta_fuel %>% filter(case==n)
 
  mean_fuel  = delta_now                                            %>% 
              select(-c(time,case,desc))                            %>% 
              group_by(site,treatment)                              %>% 
              summarize_all(mean,na.rm=TRUE)
    
  deltafuel_mean = rbind(deltafuel_mean,mean_fuel)
    
  sd_fuel  = delta_now                                             %>% 
             select(-c(time,case,desc))                            %>% 
             group_by(site,treatment)                              %>% 
             summarize_all(sd,na.rm=TRUE)
  deltafuel_sd = rbind(deltafuel_sd,sd_fuel)
    
     
}


```





```{r PlotDeltaFuel, echo=FALSE}


plot_df = deltafuel_mean

for(d in sequence(n_fuel)){
  f_vnam = fuel_vars[d]
  f_desc = fuel_desc[d]
  plot = ggplot(plot_df,aes_string(x = "site",y=f_vnam,
                   ymin=plot_df[[f_vnam]]-deltafuel_sd[[f_vnam]],
                   ymax=plot_df[[f_vnam]]+deltafuel_sd[[f_vnam]],
                   colour="treatment")) +
       geom_point(size=2) +
       geom_errorbar(width=0)+
       geom_hline(yintercept = 0, color="black",linetype=2)+
       coord_flip() +
       scale_colour_manual(values=ens_colour) +
       ylab(paste0("Relative change in ", f_desc," (%)")) +
       xlab("") +
       theme_grey( base_size = gg_ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5) +
       theme( legend.title =element_blank()
            , legend.position="bottom"
            , legend.box = "vertical"
            , legend.margin = margin()
            , axis.text.x       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            , axis.text.y       = element_text( size   = gg_ptsz
                                              , margin = unit(rep(0.35,times=4),"cm"))#end element_text
            )#end theme+
  
  
  for (d in sequence(ndevice)){
    f_output = paste0(f_vnam,"_delta.",gg_device[d])
    dummy    = ggsave( filename = f_output
                    , plot     = plot
                    , device   = gg_device[d]
                    , path     = mean_path
                    , width    = gg_widthn*0.5
                    , height   = gg_height*0.4
                    , units    = gg_units
                    , dpi      = gg_depth
                    )
   }
       

  
}





```

